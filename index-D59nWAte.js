"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./index-fMyz1k60.js"),z=require("./is-plan-event-enabled-DF66Renz.js");function y(n){return n.toLowerCase().replace(".","").replace(/\s+/g,"-")}function m(n,t){return t===void 0&&(t=!1),t?btoa(n).replace(/=/g,""):void 0}function N(n){return("Integration"in n?n.Integration:n).prototype.name}function S(n,t,r){var i,o;try{var a=((o=(i=window==null?void 0:window.performance)===null||i===void 0?void 0:i.getEntriesByName(n,"resource"))!==null&&o!==void 0?o:[])[0];a&&t.stats.gauge("legacy_destination_time",Math.round(a.duration),e.__spreadArray([r],a.duration<100?["cached"]:[],!0))}catch{}}function O(n,t,r){var i;if("Integration"in n){var o={user:function(){return r.user()},addIntegration:function(){}};n(o),i=n.Integration}else i=n;var a=new i(t);return a.analytics=r,a}function D(n,t,r,i){return e.__awaiter(this,void 0,void 0,function(){var o,a,s,l,u,c;return e.__generator(this,function(h){switch(h.label){case 0:o=y(t),a=m(o,i),s=e.getNextIntegrationsURL(),l="".concat(s,"/integrations/").concat(a??o,"/").concat(r,"/").concat(a??o,".dynamic.js.gz"),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,e.loadScript(l)];case 2:return h.sent(),S(l,n,t),[3,4];case 3:throw u=h.sent(),n.stats.gauge("legacy_destination_time",-1,["plugin:".concat(t),"failed"]),u;case 4:return c=window["".concat(o,"Deps")],[4,Promise.all(c.map(function(f){return e.loadScript(s+f+".gz")}))];case 5:return h.sent(),window["".concat(o,"Loader")](),[2,window["".concat(o,"Integration")]]}})})}function E(n,t,r){return e.__awaiter(this,void 0,void 0,function(){var i,o,a,s;return e.__generator(this,function(l){return i=e.getNextIntegrationsURL(),o=y(n),a=m(n,r),s="".concat(i,"/integrations/").concat(a??o,"/").concat(t,"/").concat(a??o,".dynamic.js.gz"),[2,e.unloadScript(s)]})})}function M(n){var t,r,i,o;return(o=(r=(t=n==null?void 0:n.versionSettings)===null||t===void 0?void 0:t.override)!==null&&r!==void 0?r:(i=n==null?void 0:n.versionSettings)===null||i===void 0?void 0:i.version)!==null&&o!==void 0?o:"latest"}var A=function(n,t){var r,i=t.type,o=t.bundlingStatus,a=t.versionSettings,s=o!=="unbundled"&&(i==="browser"||((r=a==null?void 0:a.componentTypes)===null||r===void 0?void 0:r.includes("browser")));return!n.startsWith("Segment")&&n!=="Iterable"&&s},k=function(n,t){var r=t.All===!1&&t[n]===void 0;return t[n]===!1||r};function j(n,t){return e.__awaiter(this,void 0,void 0,function(){var r,i=this;return e.__generator(this,function(o){switch(o.label){case 0:return r=[],e.isOffline()?[2,t]:[4,e.pWhile(function(){return t.length>0&&e.isOnline()},function(){return e.__awaiter(i,void 0,void 0,function(){var a,s,l;return e.__generator(this,function(u){switch(u.label){case 0:return a=t.pop(),a?[4,e.attempt(a,n)]:[2];case 1:return s=u.sent(),l=s instanceof e.Context,l||r.push(a),[2]}})})})];case 1:return o.sent(),r.map(function(a){return t.pushWithBackoff(a)}),[2,t]}})})}var w=function(){function n(t,r,i,o,a,s){o===void 0&&(o={});var l=this;this.options={},this.type="destination",this.middleware=[],this.initializePromise=e.createDeferred(),this.flushing=!1,this.name=t,this.version=r,this.settings=e.__assign({},o),this.disableAutoISOConversion=a.disableAutoISOConversion||!1,this.integrationSource=s,this.settings.type&&this.settings.type==="browser"&&delete this.settings.type,this.initializePromise.promise.then(function(u){return l._initialized=u},function(){}),this.options=a,this.buffer=a.disableClientPersistence?new e.PriorityQueue(4,[]):new e.PersistedPriorityQueue(4,"".concat(i,":dest-").concat(t)),this.scheduleFlush()}return n.prototype.isLoaded=function(){return!!this._ready},n.prototype.ready=function(){var t=this;return this.initializePromise.promise.then(function(){var r;return(r=t.onReady)!==null&&r!==void 0?r:Promise.resolve()})},n.prototype.load=function(t,r){var i;return e.__awaiter(this,void 0,void 0,function(){var o,a,s=this;return e.__generator(this,function(l){switch(l.label){case 0:return this._ready||this.onReady!==void 0?[2]:(i=this.integrationSource)!==null&&i!==void 0?(a=i,[3,3]):[3,1];case 1:return[4,D(t,this.name,this.version,this.options.obfuscate)];case 2:a=l.sent(),l.label=3;case 3:o=a,this.integration=O(o,this.settings,r),this.onReady=new Promise(function(u){var c=function(){s._ready=!0,u(!0)};s.integration.once("ready",c)}),this.integration.on("initialize",function(){s.initializePromise.resolve(!0)});try{e.recordIntegrationMetric(t,{integrationName:this.name,methodName:"initialize",type:"classic"}),this.integration.initialize()}catch(u){throw e.recordIntegrationMetric(t,{integrationName:this.name,methodName:"initialize",type:"classic",didError:!0}),this.initializePromise.resolve(!1),u}return[2]}})})},n.prototype.unload=function(t,r){return E(this.name,this.version,this.options.obfuscate)},n.prototype.addMiddleware=function(){for(var t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];this.middleware=(t=this.middleware).concat.apply(t,r)},n.prototype.shouldBuffer=function(t){return t.event.type!=="page"&&(e.isOffline()||this._ready!==!0||this._initialized!==!0)},n.prototype.send=function(t,r,i){var o,a;return e.__awaiter(this,void 0,void 0,function(){var s,l,u,c,h,f;return e.__generator(this,function(v){switch(v.label){case 0:return this.shouldBuffer(t)?(this.buffer.push(t),this.scheduleFlush(),[2,t]):(s=(a=(o=this.options)===null||o===void 0?void 0:o.plan)===null||a===void 0?void 0:a.track,l=t.event.event,s&&l&&this.name!=="Segment.io"&&(u=s[l],z.isPlanEventEnabled(s,u)?t.updateEvent("integrations",e.__assign(e.__assign({},t.event.integrations),u==null?void 0:u.integrations)):(t.updateEvent("integrations",e.__assign(e.__assign({},t.event.integrations),{All:!1,"Segment.io":!0})),t.cancel(new e.ContextCancelation({retry:!1,reason:"Event ".concat(l," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),u!=null&&u.enabled&&(u==null?void 0:u.integrations[this.name])===!1&&t.cancel(new e.ContextCancelation({retry:!1,reason:"Event ".concat(l," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),[4,e.applyDestinationMiddleware(this.name,t.event,this.middleware)]);case 1:if(c=v.sent(),c===null)return[2,t];h=new r(c,{traverse:!this.disableAutoISOConversion}),e.recordIntegrationMetric(t,{integrationName:this.name,methodName:i,type:"classic"}),v.label=2;case 2:return v.trys.push([2,5,,6]),this.integration?[4,this.integration.invoke.call(this.integration,i,h)]:[3,4];case 3:v.sent(),v.label=4;case 4:return[3,6];case 5:throw f=v.sent(),e.recordIntegrationMetric(t,{integrationName:this.name,methodName:i,type:"classic",didError:!0}),f;case 6:return[2,t]}})})},n.prototype.track=function(t){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(r){return[2,this.send(t,e.dist.Track,"track")]})})},n.prototype.page=function(t){var r;return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(i){switch(i.label){case 0:return!((r=this.integration)===null||r===void 0)&&r._assumesPageview&&!this._initialized&&this.integration.initialize(),[4,this.initializePromise.promise];case 1:return i.sent(),[2,this.send(t,e.dist.Page,"page")]}})})},n.prototype.identify=function(t){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(r){return[2,this.send(t,e.dist.Identify,"identify")]})})},n.prototype.alias=function(t){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(r){return[2,this.send(t,e.dist.Alias,"alias")]})})},n.prototype.group=function(t){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(r){return[2,this.send(t,e.dist.Group,"group")]})})},n.prototype.scheduleFlush=function(){var t=this;this.flushing||setTimeout(function(){return e.__awaiter(t,void 0,void 0,function(){var r;return e.__generator(this,function(i){switch(i.label){case 0:return e.isOffline()||this._ready!==!0||this._initialized!==!0?(this.scheduleFlush(),[2]):(this.flushing=!0,r=this,[4,j(this,this.buffer)]);case 1:return r.buffer=i.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},Math.random()*5e3)},n}();function L(n,t,r,i,o,a){var s,l;if(r===void 0&&(r={}),i===void 0&&(i={}),e.isServer())return[];t.plan&&(i=i??{},i.plan=t.plan);var u=(l=(s=t.middlewareSettings)===null||s===void 0?void 0:s.routingRules)!==null&&l!==void 0?l:[],c=t.integrations,h=i.integrations,f=e.mergedOptions(t,i??{}),v=a==null?void 0:a.reduce(function(d,p){var _;return e.__assign(e.__assign({},d),(_={},_[N(p)]=p,_))},{}),b=new Set(e.__spreadArray(e.__spreadArray([],Object.keys(c).filter(function(d){return A(d,c[d])}),!0),Object.keys(v||{}).filter(function(d){return e.isPlainObject(c[d])||e.isPlainObject(h==null?void 0:h[d])}),!0));return Array.from(b).filter(function(d){return!k(d,r)}).map(function(d){var p=c[d],_=M(p),g=new w(d,_,n,f[d],i,v==null?void 0:v[d]),P=u.filter(function(I){return I.destinationName===d});return P.length>0&&o&&g.addMiddleware(o),g})}exports.LegacyDestination=w;exports.ajsDestinations=L;
